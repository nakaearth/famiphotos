<source>
  type forward
  port 24224
  tag rails.log
</source>

<source>
  type tail
  path log/rails_application_development.log
  tag slack
  format multiline
  format_firstline /^., /
  format1 /^., \[(?<time>[^\.]+).+\][ ]+(?<level>[^ ]+) -- :(?<message>.*)$/
  time_format %Y-%m-%dT%H:%M:%S
</source>

<source>
  type tail
  path log/rails_application_development.log
  tag slack.rails.row
  format multiline
  format_firstline /^., /
  format1 /^., \[(?<time>[^\.]+).+\][ ]+(?<level>[^ ]+) -- :(?<message>.*)$/
  time_format %Y-%m-%dT%H:%M:%S
</source>

# TODO mysqlのログをElasticsearchに入れる
<source>
  type mysql_slow_query
  path log/mysql_query.log
  tag mysqld_slow_query
</source>

<match rails.*>
  host 192.168.25.30
  port 9200
  index_name famiphoto 
  type_name fluentd
  type elasticsearch
</match>

# railsのエラーログを
<match slack.rails.row>
  type rewrite_tag_filter
  rewriterule1 level ERROR rails.info_and_error
  rewriterule2 level FATAL rails.info_and_error
  rewriterule3 level INFO  rails.info_and_error
  rewriterule4 level .+  clear
</match>

<match clear>
  type null
</match>

<match mysql_slow_query*>
  host 192.168.25.30
  port 9200
  index_name mysql_log
  type_name mysqld
  type elasticsearch
</match>

<match slack>
  type slack
  webhook_url https://hooks.slack.com/services/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
  channel general
  username rails_dog
  flush_interval 5s
  icon_emoji :dog:
  message_keys level,message
  message "[%s] %s"
</match>

<match rails.info_and_error>
  type slack
  webhook_url https://hooks.slack.com/services/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
  channel general
  username rails_ghost
  flush_interval 5s
  icon_emoji :ghost:
  message_keys level,message
  message "[%s] %s"
</match>

<match rails.log>
  type file
  path /usr/local/project/famiphotos/log/rails_application_develop.log
</match>

